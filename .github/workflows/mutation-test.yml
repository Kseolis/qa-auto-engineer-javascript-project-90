name: Mutation Testing

on:
  schedule:
    # ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº Ğ² 2:00 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

jobs:
  mutation-test:
    name: Stryker Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ğ”Ğ»Ñ incremental mode
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - name: Run Mutation Tests
        run: npm run test:mutation
        continue-on-error: true  # ĞĞµ Ğ¿Ğ°Ğ´Ğ°Ñ‚ÑŒ ĞµÑĞ»Ğ¸ score Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¹
      
      - name: Upload Mutation Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-report
          path: |
            mutation-report.html
            mutation-report.json
            .stryker-tmp/
          retention-days: 30
      
      - name: Comment PR with Mutation Score
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const path = require('path')
            
            // Stryker ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ JSON Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ² ĞºĞ¾Ñ€Ğ½Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
            const reportPath = path.join(process.cwd(), 'mutation-report.json')
            if (!fs.existsSync(reportPath)) {
              console.log('Mutation report not found, skipping comment')
              return
            }
            
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'))
            const score = report.mutationScore
            
            const comment = `## ğŸ§¬ Mutation Testing Results
            
            **Mutation Score**: ${score.toFixed(2)}%
            
            | Status | Count |
            |--------|-------|
            | âœ… Killed | ${report.killed} |
            | âŒ Survived | ${report.survived} |
            | â±ï¸ Timeout | ${report.timeout} |
            | âšª No Coverage | ${report.noCoverage} |
            
            ${score >= 80 ? 'âœ… Great test quality!' : score >= 60 ? 'ğŸŸ¡ Good, but could be better' : 'âŒ Test quality needs improvement'}
            `
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            })

